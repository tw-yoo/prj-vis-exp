<div class="page-content main-task-page">
    <div class="task-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2>Compositional Chart Question Generation</h2>
        <select id="chart-dropdown" style="padding: 8px; font-size: 16px;"></select>
    </div>

    <div class="req-box">
        <p>(1) <strong>read</strong> a given chart; (2) <strong>create</strong> a compositional question that can be answered from the chart; (3) <strong>calculate</strong> the answer; (4) <strong>mark</strong> what kind of arithmetic operations did you use to get the answer; (5) <strong>explain</strong> how did you get the answer.</p>
    </div>

    <!-- Chart and Input side-by-side -->
    <div class="chart-input-grid">
        <!-- Left: Chart -->
        <div class="chart-container">
            <h3>Chart</h3>
            <div id="chart-main-view__host" class="chart-host">
                <div id="chart-main-view" class="d3chart-container"></div>
            </div>
        </div>

        <!-- Right: Input Fields -->
        <div class="input-container">
            <div class="response-header">
                <h3>Your Response</h3>
                <div class="help-btn-wrapper">
                    <button type="button" class="help-btn" aria-label="Show examples">?</button>
                    <div class="help-tooltip">
                        <div class="tooltip-header">Examples: Good Questions</div>
                        
                        <!-- Example 1 -->
                        <div class="tooltip-example">
                            <div class="ex-title">ðŸ“Š Example 1: Simple Bar Chart</div>
                            <div class="ex-row">
                                <span class="ex-label">Q:</span>
                                <span>What is the average of the top 3 countries by damage?</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">A:</span>
                                <span>173.33</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">Ops:</span>
                                <span class="ex-ops">Sort â€¢ Nth â€¢ Average</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">Steps:</span>
                                <div class="ex-steps">
                                    1. Sort by damage descending<br>
                                    2. Get top 3: Japan(360), China(110), Italy(50)<br>
                                    3. Average: (360+110+50)/3 = 173.33
                                </div>
                            </div>
                        </div>

                        <!-- Example 2 -->
                        <div class="tooltip-example">
                            <div class="ex-title">ðŸ“ˆ Example 2: Line Chart</div>
                            <div class="ex-row">
                                <span class="ex-label">Q:</span>
                                <span>How many years are above the average?</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">A:</span>
                                <span>6</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">Ops:</span>
                                <span class="ex-ops">Average â€¢ Filter â€¢ Count</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">Steps:</span>
                                <div class="ex-steps">
                                    1. Calculate overall average: 45.5<br>
                                    2. Filter years where value > 45.5<br>
                                    3. Count filtered results: 6 years
                                </div>
                            </div>
                        </div>

                        <!-- Example 3 -->
                        <div class="tooltip-example">
                            <div class="ex-title">ðŸ“Š Example 3: Grouped Bar Chart</div>
                            <div class="ex-row">
                                <span class="ex-label">Q:</span>
                                <span>Difference between max in Group A and min in Group B?</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">A:</span>
                                <span>45</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">Ops:</span>
                                <span class="ex-ops">Filter â€¢ Find Extremum â€¢ Difference</span>
                            </div>
                            <div class="ex-row">
                                <span class="ex-label">Steps:</span>
                                <div class="ex-steps">
                                    1. Filter Group A, find max: 85<br>
                                    2. Filter Group B, find min: 40<br>
                                    3. Difference: 85 - 40 = 45
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stage-panel is-active" data-stage="qa">
                <div data-component="open-ended"
                     data-id="q-question"
                     data-labelText="1. Your Question"
                     data-placeholder="Enter your question here..."
                     data-multiline="true"></div>

                <div data-component="open-ended"
                     data-id="q-answer"
                     data-labelText="2. The Answer"
                     data-placeholder="Enter the single correct answer (e.g., '14019', 'USA', 'True')"
                     data-multiline="false"></div>

                <p class="stage-hint">Continue to the next step to record the operations and explanation.</p>
            </div>

            <div class="stage-panel" data-stage="ops" style="display: none;">
                <div class="qa-review">
                    <div class="qa-review-item">
                        <div class="qa-review-label">1. Your Question</div>
                        <div class="qa-review-text" id="qa-review-question">No question yet.</div>
                    </div>
                    <div class="qa-review-item">
                        <div class="qa-review-label">2. The Answer</div>
                        <div class="qa-review-text" id="qa-review-answer">No answer yet.</div>
                    </div>
                </div>

                <div class="ops-checklist">
                    <label class="question">3. Operations Used (multiple)</label>
                    <div class="ops-checklist-body" id="ops-checklist"></div>
                    <div class="ops-custom">
                        <label class="question optional-question" for="ops-custom-input">Add/Remove custom operations</label>
                        <div class="ops-custom-input-row">
                            <input id="ops-custom-input" type="text" placeholder="Add an operation and press + or Enter">
                            <button type="button" id="ops-custom-add-btn" class="ops-custom-add" aria-label="Add custom operation">+</button>
                        </div>
                        <div class="ops-custom-list" id="ops-custom-list"></div>
                    </div>
                </div>

                <div data-component="open-ended"
                     data-id="q-explanation"
                     data-labelText="4. Explanation (Step-by-step)"
                     data-placeholder="1. ... &#10;2. ... &#10;3. ... "
                     data-multiline="true">
                </div>
            </div>
        </div>
    </div>

    <style>
        .main-task-page {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Response Header with Help Button */
        .response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0 0 12px 0;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 6px;
        }

        .response-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        /* Help Button with Tooltip */
        .help-btn-wrapper {
            position: relative;
        }

        .help-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid #2196f3;
            background: #fff;
            color: #2196f3;
            font-weight: bold;
            font-size: 15px;
            cursor: help;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
        }

        .help-btn:hover {
            background: #2196f3;
            color: #fff;
            transform: scale(1.05);
        }

        /* Tooltip Styles */
        .help-tooltip {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            width: 650px;
            max-width: 95vw;
            background: #1f2937;
            color: #f9fafb;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .help-btn-wrapper:hover .help-tooltip,
        .help-tooltip:hover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .tooltip-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4b5563;
            color: #60a5fa;
        }

        .tooltip-example {
            background: #374151;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .tooltip-example:last-of-type {
            margin-bottom: 10px;
        }

        .ex-title {
            font-weight: 700;
            font-size: 14px;
            color: #93c5fd;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #4b5563;
        }

        .ex-row {
            display: flex;
            gap: 8px;
            margin: 6px 0;
            font-size: 13px;
            line-height: 1.5;
        }

        .ex-label {
            font-weight: 700;
            color: #60a5fa;
            min-width: 45px;
            flex-shrink: 0;
        }

        .ex-ops {
            color: #86efac;
            font-weight: 600;
        }

        .ex-steps {
            flex: 1;
            color: #d1d5db;
            line-height: 1.6;
        }

        .tooltip-footer {
            background: #065f46;
            color: #a7f3d0;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }

        /* Scrollbar for tooltip */
        .help-tooltip::-webkit-scrollbar {
            width: 8px;
        }

        .help-tooltip::-webkit-scrollbar-track {
            background: #4b5563;
            border-radius: 4px;
        }

        .help-tooltip::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 4px;
        }

        .help-tooltip::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Chart and Input Grid */
        .chart-input-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container, .input-container {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            min-height: 620px;
            display: flex;
            flex-direction: column;
        }

        .chart-container h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #333;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 6px;
        }

        .input-container > div {
            margin-bottom: 15px;
        }

        .stage-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .stage-tab {
            padding: 10px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .stage-tab.is-active {
            background: #e0f2fe;
            border-color: #38bdf8;
            color: #0f172a;
        }
        .stage-panel {
            margin-top: 6px;
        }
        .stage-panel.is-active {
            display: block;
        }
        .stage-hint {
            margin: 6px 0 0;
            font-size: 13px;
            color: #6b7280;
        }
        .ops-checklist {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 16px;
            background: #f9fafb;
            position: relative;
            overflow: visible;
        }
        .ops-checklist .question {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .ops-checklist-body {
            max-height: none;
            overflow: visible;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 8px;
            background: #fff;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 8px;
        }
        .ops-check {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 6px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            position: relative;
        }
        .ops-check input {
            pointer-events: auto;
        }

        /* Operation Tooltip */
        .ops-check::after {
            content: attr(data-tip);
            position: absolute;
            left: 0;
            bottom: calc(100% + 8px);
            background: #1f2937;
            color: #f9fafb;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            width: 280px;
            max-width: 80vw;
            opacity: 0;
            visibility: hidden;
            transform: translateY(4px);
            transition: all 0.2s ease;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 100;
            pointer-events: none;
            white-space: pre-line;
        }

        .ops-check:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .qa-review {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 12px;
            background: #f8fafc;
            display: grid;
            gap: 6px;
        }
        .qa-review-item {
            display: block;
            line-height: 1.4;
        }
        .qa-review-label {
            font-weight: 700;
            color: #0f172a;
            margin-right: 6px;
            display: inline;
        }
        .qa-review-label::after {
            content: ': ';
        }
        .qa-review-text {
            display: inline;
            border: none;
            padding: 0;
            background: transparent;
            min-height: auto;
            white-space: pre-wrap;
        }
        .ops-custom {
            margin-top: 10px;
            border-top: 1px solid #e5e7eb;
            padding-top: 10px;
        }
        .ops-custom-input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            margin-bottom: 8px;
        }
        .ops-custom-input-row input {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        .ops-custom-add {
            padding: 8px 12px;
            border: 1px solid #38bdf8;
            background: #0ea5e9;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            min-width: 44px;
        }
        .ops-custom-add:hover {
            filter: brightness(1.05);
        }
        .ops-custom-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .ops-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #e0f2fe;
            color: #0f172a;
            border-radius: 999px;
            border: 1px solid #bae6fd;
        }
        .ops-chip__label {
            font-weight: 600;
        }
        .ops-chip__remove {
            border: none;
            background: #f1f5f9;
            color: #0f172a;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-weight: 800;
            line-height: 1;
        }
        .ops-chip__remove:hover {
            background: #e2e8f0;
        }
        .input-container textarea#q-explanation {
            min-height: 4.5em;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .chart-input-grid {
                grid-template-columns: 1fr;
            }
            
            .help-tooltip {
                width: 600px;
            }
        }

        @media (max-width: 768px) {
            .help-tooltip {
                width: 100%;
                max-width: calc(100vw - 40px);
                left: 50%;
                right: auto;
                transform: translateX(-50%) translateY(-10px);
            }

            .help-btn-wrapper:hover .help-tooltip {
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>
</div>